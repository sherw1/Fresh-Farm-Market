@page
@model AS_Assignment2.Pages.HomeModel
@{
    ViewData["Title"] = "Home";
}

<h2>Welcome, @Model.Member?.FullName</h2>

@if (Model.PasswordExpired)
{
    <div style="background-color: #ffcccc; padding: 10px; margin-bottom: 20px; border: 1px solid red;">
        <strong>Warning:</strong> Your password has expired (90 days old). 
        <a href="/Account/ChangePassword" style="font-weight: bold;">Change your password now</a>
    </div>
}

@if (Model.Member != null)
{
    <div>
        <h3>Your Profile</h3>
        <p><strong>Full Name:</strong> @Model.Member.FullName</p>
        <p><strong>Email:</strong> @Model.Member.Email</p>
        <p><strong>Gender:</strong> @Model.Member.Gender</p>
        <p><strong>Mobile No:</strong> @Model.Member.MobileNo</p>
        <p><strong>Delivery Address:</strong> @Model.Member.DeliveryAddress</p>
        <p><strong>About Me:</strong> @Model.Member.AboutMe</p>
        <p><strong>Credit Card (Decrypted):</strong> @Model.DecryptedCreditCard</p>
        <p><strong>Two-Factor Authentication:</strong> 
            @if (Model.Member.TwoFactorEnabled)
            {
                <span style="color: #28a745;"> Enabled</span>
            }
            else
            {
                <span style="color: #dc3545;"> Disabled</span>
            }
            
        </p>
        @if (!string.IsNullOrEmpty(Model.Member.PhotoPath))
        {
            <p><strong>Photo:</strong></p>
            <img src="@Model.Member.PhotoPath" alt="Profile Photo" width="200" />
        }
        <div style="margin-top: 20px;">
            <a href="/Account/ChangePassword">Change Password</a> | 
            <a href="/Account/ManageTwoFactor">Manage 2FA</a> | 
            <a href="/Account/Logout">Logout</a>
        </div>
    </div>
}
else
{
    <p>Please <a href="/Account/Login">login</a> to view your profile.</p>
}

@section Scripts {
    <script>
        (function() {
            // Clear the logout flag when successfully loading Home page with authenticated user
            // This fixes the issue where different accounts can't login after a logout
            if (@((Model.Member != null).ToString().ToLower())) {
                // User is authenticated and page loaded successfully
                // Clear any logout flags
                window.name = "";
                sessionStorage.removeItem('loggedOut');
                localStorage.removeItem('loggedOut');
            }

            // Prevent back button after logout
            window.onpageshow = function(event) {
                if (event.persisted || (window.performance && window.performance.navigation.type === 2)) {
                    // Page loaded from cache - check if we're actually logged in
                    if (@((Model.Member == null).ToString().ToLower())) {
                        // Not logged in - force reload or redirect
                        window.location.href = "/Account/Login";
                    }
                }
            };

            // Prevent using browser back button only if NOT authenticated
            if (@((Model.Member == null).ToString().ToLower())) {
                window.history.pushState(null, "", window.location.href);
                window.onpopstate = function() {
                    window.history.pushState(null, "", window.location.href);
                    window.location.href = "/Account/Login";
                };
            }

            // Set flag when leaving page via logout
            var logoutLinks = document.querySelectorAll('a[href*="Logout"]');
            logoutLinks.forEach(function(link) {
                link.addEventListener('click', function() {
                    window.name = "loggedOut";
                    sessionStorage.setItem('loggedOut', 'true');
                });
            });
        })();
    </script>
}
